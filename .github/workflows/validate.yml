name: Validate TaggerScript

on:
  push:
    branches: [ main ]
    paths:
      - naming.pts
  pull_request:
    branches: [ main ]
    paths:
      - naming.pts
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update apt
        run: sudo apt-get update

      - name: Install MusicBrainz Picard
        run: sudo apt-get install -y picard

      - name: Validate TaggerScript syntax
        run: python3 scripts/validate_tagger.py naming.pts

      - name: Check for balanced parentheses
        run: |
          python3 -c "
          import sys
          try:
              with open('naming.pts', 'r', encoding='utf-8') as f:
                  content = f.read()

              if not content.strip():
                  print('❌ ERROR: File is empty')
                  sys.exit(1)

              parens = 0
              brackets = 0
              line_num = 1
              col = 0

              for i, char in enumerate(content):
                  col += 1
                  if char == '\n':
                      line_num += 1
                      col = 0
                  if char == '(':
                      parens += 1
                  elif char == ')':
                      parens -= 1
                  if char == '[':
                      brackets += 1
                  elif char == ']':
                      brackets -= 1

                  if parens < 0:
                      print(f'❌ ERROR: Unbalanced parentheses at line {line_num}, column {col}')
                      sys.exit(1)
                  if brackets < 0:
                      print(f'❌ ERROR: Unbalanced brackets at line {line_num}, column {col}')
                      sys.exit(1)

              if parens != 0:
                  print(f'❌ ERROR: {parens} unclosed parentheses')
                  sys.exit(1)

              if brackets != 0:
                  print(f'❌ ERROR: {brackets} unclosed brackets')
                  sys.exit(1)

              print('✅ Parentheses and brackets are balanced')
          except Exception as e:
              print(f'❌ ERROR: {e}')
              sys.exit(1)
          "

      - name: Validate file encoding
        run: |
          file naming.pts | grep -q "UTF-8" && echo "✅ File encoding is UTF-8" || (echo "❌ ERROR: File must be UTF-8 encoded" && exit 1)
